{"version":3,"file":"token-action-hud-fu.min.js","sources":["constants.js","action-handler.js","defaults.js","roll-handler.js","settings.js","system-manager.js","utils.js"],"sourcesContent":["/**\n * Module-based constants\n */\nexport const MODULE = {\n    ID: 'token-action-hud-fu'\n}\n\n/**\n * Core module\n */\nexport const CORE_MODULE = {\n    ID: 'token-action-hud-core'\n}\n\n/**\n * Core module version required by the system module\n */\nexport const REQUIRED_CORE_MODULE_VERSION = '2.0'\n\n/**\n * Action types\n */\nexport const ACTION_TYPE = {\n    basic: 'TYPES.Item.basic',\n    weapon: 'TYPES.Item.weapon',\n    shield: 'TYPES.Item.shield',\n    armor: 'TYPES.Item.armor',\n    accessory: 'TYPES.Item.accessory',\n    consumable: 'TYPES.Item.consumable',\n    treasure: 'TYPES.Item.treasure',\n    class: 'TYPES.Item.class',\n    skill: 'TYPES.Item.skill',\n    heroic: 'TYPES.Item.heroic',\n    spell: 'TYPES.Item.spell',\n    miscAbility: 'TYPES.Item.miscAbility',\n    rule: 'TYPES.Item.rule',\n    behavior: 'TYPES.Item.behavior',\n    ritual: 'TYPES.Item.ritual',\n    project: 'TYPES.Item.project',\n    classFeature: 'TYPES.Item.classFeature',\n    optionalFeature: 'TYPES.Item.optionalFeature',\n    effect: 'TYPES.Item.effect',\n\n    action: 'FU.Action',\n    attack: 'FU.Attack',\n    equipment: 'FU.Equipment',\n    guard: 'FU.Guard',\n    inventory: 'FU.Inventory',\n    hinder: 'FU.Hinder',\n    objective: 'FU.Objective',\n    study: 'FU.Study',\n\n    check: 'tokenActionHud.fu.check.label',\n    travel: 'tokenActionHud.fu.check.travelcheck',\n    utility: 'tokenActionHud.utility'\n}\n\n/**\n * Groups\n */\nexport const GROUP = {\n\n    equipped: { id: 'equipped', name: 'tokenActionHud.fu.equipped.label', type: 'system' },\n    basic: { id: 'basic', name: 'TYPES.Item.basic', type: 'system' },\n    weapon: { id: 'weapon', name: 'TYPES.Item.weapon', type: 'system' },\n    shield: { id: 'shield', name: 'TYPES.Item.shield', type: 'system' },\n    armor: { id: 'armor', name: 'TYPES.Item.armor', type: 'system' },\n    accessory: { id: 'accessory', name: 'TYPES.Item.accessory', type: 'system' },\n    consumable: { id: 'consumable', name: 'TYPES.Item.consumable', type: 'system' },\n    treasure: { id: 'treasure', name: 'TYPES.Item.treasure', type: 'system' },\n    class: { id: 'class', name: 'TYPES.Item.class', type: 'system' },\n    skill: { id: 'skill', name: 'TYPES.Item.skill', type: 'system' },\n    heroic: { id: 'heroic', name: 'TYPES.Item.heroic', type: 'system' },\n    miscAbility: { id: 'miscAbility', name: 'TYPES.Item.miscAbility', type: 'system' },\n    rule: { id: 'rule', name: 'TYPES.Item.rule', type: 'system' },\n    behavior: { id: 'behavior', name: 'TYPES.Item.behavior', type: 'system' },\n    spell: { id: 'spell', name: 'TYPES.Item.spell', type: 'system' },\n    ritual: { id: 'ritual', name: 'TYPES.Item.ritual', type: 'system' },\n    project: { id: 'project', name: 'TYPES.Item.project', type: 'system' },\n    classFeature: { id: 'classFeature', name: 'TYPES.Item.classFeature', type: 'system' },\n    optionalFeature: { id: 'optionalFeature', name: 'TYPES.Item.optionalFeature', type: 'system' },\n    effect: { id: 'effect', name: 'TYPES.Item.effect', type: 'system' },\n\n    // Action Labels\n    check: { id: 'check', name: 'tokenActionHud.fu.check.label', type: 'system' },\n    action: { id: 'action', name: 'FU.Actions', type: 'system' },\n    attack: { id: 'attack', name: 'FU.attack', type: 'system' },\n    equipment: { id: 'equipment', name: 'FU.equipment', type: 'system' },\n    guard: { id: 'guard', name: 'FU.guard', type: 'system' },\n    inventory: { id: 'inventory', name: 'FU.inventory', type: 'system' },\n    hinder: { id: 'hinder', name: 'FU.hinder', type: 'system' },\n    objective: { id: 'objective', name: 'FU.objective', type: 'system' },\n    study: { id: 'study', name: 'FU.study', type: 'system' },\n\n    // Utility Labels\n    combat: { id: 'combat', name: 'tokenActionHud.combat', type: 'system' },\n    token: { id: 'token', name: 'tokenActionHud.token', type: 'system' },\n    utility: { id: 'utility', name: 'tokenActionHud.utility', type: 'system' },\n\n    // Effects\n    temporaryEffect: { id: 'temporaryEffect', name: 'FU.TemporaryEffects', type: 'system' },\n    passiveEffect: { id: 'passiveEffect', name: 'FU.PassiveEffects', type: 'system' },\n    inactiveEffect: { id: 'inactiveEffect', name: 'FU.InactiveEffects', type: 'system' },\n\n    // Downtime\n    downtime: { id: 'downtime', name: 'FU.Downtime', type: 'system' }\n}\n\n/**\n * Item types\n */\nexport const ITEM_TYPE = {\n    basic: { groupId: 'basic' },\n    weapon: { groupId: 'weapon' },\n    customWeapon: { groupId: 'weapon' },\n    shield: { groupId: 'shield' },\n    armor: { groupId: 'armor' },\n    accessory: { groupId: 'accessory' },\n    consumable: { groupId: 'consumable' },\n    treasure: { groupId: 'treasure' },\n    class: { groupId: 'class' },\n    skill: { groupId: 'skill' },\n    heroic: { groupId: 'heroic' },\n    miscAbility: { groupId: 'miscAbility' },\n    rule: { groupId: 'rule' },\n    spell: { groupId: 'spell' },\n    ritual: { groupId: 'ritual' },\n    project: { groupId: 'project' },\n    classFeature: { groupId: 'classFeature' },\n    optionalFeature: { groupId: 'optionalFeature' },\n    effect: { groupId: 'effect' }\n}\n","// System Module Imports\nimport { ACTION_TYPE, ITEM_TYPE } from './constants.js'\n\nexport let ActionHandler = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Extends Token Action HUD Core's ActionHandler class and builds system-defined actions for the HUD\n     * @remarks https://github.com/Larkinabout/fvtt-token-action-hud-core/wiki/Core-Changes-for-System-Module-Developers\n     */\n    ActionHandler = class ActionHandler extends coreModule.api.ActionHandler {\n        /**\n         * Build system actions\n         * Called by Token Action HUD Core\n         * @override\n         */\n        async buildSystemActions () {\n            this.actorType = this.actor?.type\n            this.tooltipDirection = this.#getTooltipDirection()\n\n            // Set items variable\n            if (this.actor) {\n                let items = this.actor.items\n                items = coreModule.api.Utils.sortItemsByName(items)\n                this.items = items\n                this.effects = this.actor.effects\n            }\n\n            if (this.actorType === 'character') {\n                this.#buildCharacterActions()\n            } else if (this.actorType === 'npc') {\n                this.#buildNPCActions()\n            } else if (!this.actor) {\n                this.#buildMultipleTokenActions()\n            }\n        }\n\n        /**\n         * Build character actions\n         * @private\n         */\n        #buildCharacterActions () {\n            this.#buildCheckActions()\n            this.#buildCombatActions()\n            this.#buildItems()\n            // this.#buildTravel()\n            this.#buildEffects()\n            this.#buildDowntimeActions()\n        }\n\n        /**\n         * Build npc actions\n         * @private\n         */\n        #buildNPCActions () {\n            this.#buildCheckActions()\n            this.#buildCombatActions()\n            this.#buildItems()\n            this.#buildEffects()\n        }\n\n        /**\n         * Build multiple token actions\n         * @private\n         * @returns {object}\n         */\n        #buildMultipleTokenActions () {\n        }\n\n        /**\n         * Build Check Action actions for the HUD\n         *\n         * This method will create buttons for each checks action type.\n         * @private\n         */\n        async #buildCheckActions () {\n            const checkActions = [\n                { id: 'attributeCheck', name: 'Attribute Check' },\n                { id: 'openCheck', name: 'Open Check' },\n                { id: 'groupCheck', name: 'Group Check' },\n                { id: 'initiativeCheck', name: 'Initiative Check' }\n            ]\n\n            const actionTypeId = 'action'\n            const checkGroupId = 'check'\n\n            const actions = checkActions.map(action => {\n                return {\n                    id: action.id,\n                    name: coreModule.api.Utils.i18n(action.name),\n                    listName: action.name,\n                    encodedValue: [actionTypeId, action.id].join(this.delimiter) // Ensure delimiter is defined\n                }\n            })\n\n            const checkGroupData = { id: checkGroupId, type: 'system' }\n            this.addActions(actions, checkGroupData)\n        }\n\n        /**\n         * Build Combat Action actions for the HUD\n         *\n         * This method will create buttons for each combat action type.\n         * @private\n         */\n        async #buildCombatActions () {\n            const combatActions = [\n                { id: 'guardAction', name: 'Guard', rule: 'FU.GuardRule' },\n                { id: 'equipmentAction', name: 'Equipment', rule: 'FU.EquipmentRule' },\n                { id: 'hinderAction', name: 'Hinder', rule: 'FU.HinderRule' },\n                { id: 'inventoryAction', name: 'Inventory', rule: 'FU.InventoryRule' },\n                { id: 'objectiveAction', name: 'Objective', rule: 'FU.ObjectiveRule' },\n                { id: 'spellAction', name: 'Spell', rule: 'FU.SpellRule' },\n                { id: 'studyAction', name: 'Study', rule: 'FU.StudyRule' },\n                { id: 'skillAction', name: 'Skill', rule: 'FU.SkillRule' }\n            ]\n\n            const actionTypeId = 'action'\n            const combatGroupId = 'action' // Group ID for combat actions\n\n            const actions = combatActions.map(action => {\n                const actionObj = {\n                    id: action.id,\n                    name: coreModule.api.Utils.i18n(action.name),\n                    listName: action.name,\n                    encodedValue: [actionTypeId, action.id].join(this.delimiter) // Ensure delimiter is defined\n                }\n\n                // Add tooltip if action has rule text\n                if (action.rule) {\n                    const ruleText = coreModule.api.Utils.i18n(action.rule)\n                    if (ruleText && ruleText !== action.rule) { // Only if localization exists\n                        actionObj.tooltip = {\n                            content: `<h4>${actionObj.name}</h4><p>${ruleText}</p>`,\n                            class: 'tah-system-tooltip',\n                            direction: this.tooltipDirection\n                        }\n                    }\n                }\n\n                return actionObj\n            })\n\n            const combatGroupData = { id: combatGroupId, type: 'system' }\n            this.addActions(actions, combatGroupData)\n        }\n\n        /**\n         * Get tooltip direction based on TAH Core direction setting\n         * @private\n         * @returns {string} The tooltip direction (UP, DOWN, LEFT, RIGHT, CENTER)\n         */\n        #getTooltipDirection () {\n            const direction = game.settings.get('token-action-hud-core', 'direction') || 'auto'\n\n            switch (direction) {\n            case 'up':\n                return 'DOWN'\n            case 'down':\n                return 'UP'\n            case 'auto':\n            default:\n                return 'DOWN'\n            }\n        }\n\n        /**\n         * Enrich item tooltip content with additional formatting and item properties\n         * @private\n         * @param {string} name The item name\n         * @param {string} description The item description\n         * @param {object} itemData The full item data object\n         * @returns {string} Enhanced HTML content\n         */\n        #enrichItemTooltip (name, description, itemData) {\n            const itemType = itemData.type.charAt(0).toUpperCase() + itemData.type.slice(1)\n            const stats = this.#getItemStats(itemData)\n\n            const hints = [\n                \"Left-click to use\",\n                \"Right-click for sheet\"\n            ]\n\n            if (itemData.type === \"customWeapon\" && itemData.system.isTransforming)\n                hints.push(\"Ctrl+click to change forms\")\n\n            return `\n                <div class='tah-tooltip-header'>\n                    <h4>${name}</h4>\n                    <span class='tah-item-badge'>${itemType}</span>\n                </div>\n                <div class='tah-tooltip-body'>\n                    ${stats}\n                    ${description ? `<p>${description}</p>` : ''}\n                    <div class='tah-tooltip-hint'><em>${hints.join(\" ◆ \")}</em></div>\n                </div>\n            `\n        }\n\n        /**\n         * Get formatted stats for different item types\n         * @private\n         * @param {object} itemData The item data object\n         * @returns {string} Formatted stats HTML\n         */\n        #getItemStats (itemData) {\n            const stats = []\n            const { system, type } = itemData\n\n            if (!system) return ''\n\n            // Handle spell\n            if (type === 'spell' && system.rollInfo) {\n                const accuracy = system.rollInfo.accuracy?.value\n                if (accuracy !== undefined) {\n                    const primary = system.rollInfo.attributes?.primary?.value || 'DEX'\n                    const secondary = system.rollInfo.attributes?.secondary?.value || 'INS'\n                    stats.push(`<strong>Accuracy:</strong> 【${primary.toUpperCase()} + ${secondary.toUpperCase()}】+${accuracy}`)\n                }\n\n                if (system.rollInfo.damage?.hasDamage?.value) {\n                    const damage = system.rollInfo.damage.value || 0\n                    const damageType = system.rollInfo.damage.type.value || 'Physical'\n                    stats.push(`<strong>Damage:</strong> 【HR + ${damage}】 ${damageType}`)\n                }\n            }\n\n            // Handle weapon/basic\n            if ((type === 'weapon' || type === 'basic') && system.damage) {\n                const accuracy = system.accuracy?.value;\n\n                if (accuracy !== undefined) {\n                    const primary = system.attributes?.primary?.value || 'MIG'\n                    const secondary = system.attributes?.secondary?.value || 'MIG'\n                    stats.push(`<strong>Accuracy:</strong> 【${primary.toUpperCase()} + ${secondary.toUpperCase()}】+${accuracy}`)\n                }\n\n                const damage = system.damage.value || 0\n                const damageType = system.type?.value || 'Physical'\n                stats.push(`<strong>Damage:</strong> 【HR + ${damage}】 ${damageType}`)\n            }\n\n            // Handle custom weapons\n            if ((type === 'customWeapon') && system.damage) {\n                const activeForm = system[system.activeForm];\n                const accuracy = activeForm.accuracy;                \n\n                if (activeForm.accuracy !== undefined) {\n                    const primary = activeForm.attributes.primary || 'MIG';\n                    const secondary = activeForm.attributes.secondary || 'MIG';\n                    stats.push(`<strong>Accuracy:</strong> 【${primary.toUpperCase()} + ${secondary.toUpperCase()}】+${accuracy}`);\n                }\n\n                const damage = activeForm.damage.value || 0;\n                const damageType = activeForm.damage.type || 'Physical';\n                stats.push(`<strong>Damage:</strong> 【HR + ${damage}】 ${damageType}`);\n            }\n\n            return stats.length > 0 ? stats.map(stat => `<div class='tah-item-stats'>${stat}</div>`).join('') : ''\n        }\n\n        /**\n         * @description Active Effects on the actor\n         * @returns {Promise<void>}\n         */\n        async #buildEffects () {\n            const typeId = 'effect'\n            const tempGroupId = 'temporaryEffect'\n            const passiveGroupId = 'passiveEffect'\n            const inactiveGroupId = 'inactiveEffect'\n\n            const getAction = (effect) => {\n                const action = {\n                    id: effect.id,\n                    name: coreModule.api.Utils.i18n(effect.name),\n                    listName: effect.name,\n                    img: coreModule.api.Utils.getImage(effect),\n                    encodedValue: [typeId, effect.id].join(this.delimiter) // Ensure delimiter is defined\n                }\n\n                // Add tooltip if effect has description\n                if (effect.description) {\n                    action.tooltip = {\n                        content: `<h4>${effect.name}</h4><p>${effect.description}</p>`,\n                        class: 'tah-system-tooltip',\n                        direction: this.#getTooltipDirection()\n                    }\n                }\n\n                return action\n            }\n\n            /**\n             * @param {Object[]} actions\n             * @param {String} groupId\n             */\n            const addEffectGroup = (actions, groupId) => {\n                const groupData = { id: groupId, type: 'system' }\n                this.addActions(actions, groupData)\n            }\n\n            // Prepare active effects\n            const effects = this.actor.effectCategories\n            const temporaryEffects = effects.temporary.effects.map(getAction)\n            const passiveEffects = effects.passive.effects.map(getAction)\n            const inactiveEffects = effects.inactive.effects.map(getAction)\n\n            addEffectGroup(temporaryEffects, tempGroupId)\n            addEffectGroup(passiveEffects, passiveGroupId)\n            addEffectGroup(inactiveEffects, inactiveGroupId)\n        }\n\n        /**\n         * @description Active Effects on the actor\n         * @returns {Promise<void>}\n         */\n        async #buildDowntimeActions () {\n            const actionTypeId = 'utility'\n            const groupId = 'downtime'\n\n            const restAction = {\n                id: 'rest',\n                name: coreModule.api.Utils.i18n('Rest'),\n                listName: 'Rest',\n                encodedValue: [actionTypeId, 'rest'].join(this.delimiter)\n            }\n\n            // Add the travel action to the \"Travel\" group\n            const groupData = { id: groupId, type: 'system' }\n            this.addActions([restAction], groupData)\n        }\n\n        /**\n         * Build Inventory Actions for the HUD, including equipped items.\n         * @private\n         *\n         * This method handle the construction of action buttons for items in the actor's\n         * inventory, organized by equipment slots.\n         */\n        async #buildItems () {\n            // Exit if the actor has no items\n            if (this.items.size === 0) return\n\n            const actionTypeId = 'item' // Action type identifier\n            const inventoryMap = new Map() // Map for categorized inventory items\n\n            // Equipment slots\n            const slots = ['mainHand', 'offHand', 'phantom', 'armor', 'accessory', 'arcanum']\n            const equippedItemIds = new Set() // Store equipped item IDs\n\n            for (const slot of slots) {\n                const equippedItemId = this.actor.system.equipped[slot]\n                if (equippedItemId) equippedItemIds.add(equippedItemId)\n            }\n\n            // Categorize items in the inventory\n            for (const [itemId, itemData] of this.items) {\n                if (itemData.type === 'weapon' && this.actorType === 'npc') {\n                    continue\n                }\n                const typeMap = inventoryMap.get(itemData.type) ?? new Map()\n                typeMap.set(itemId, itemData)\n                inventoryMap.set(itemData.type, typeMap)\n            }\n\n            // Create action buttons for each item type\n            for (const [type, typeMap] of inventoryMap) {\n                const groupId = ITEM_TYPE[type]?.groupId\n                if (!groupId) continue // Skip if no group ID\n\n                const groupData = { id: groupId, type: 'system' } // Group data for the item type\n\n\n                // Generate actions for items in this type\n                const actions = [...typeMap].map(([itemId, itemData]) => {\n                    const id = itemId\n                    let name = itemData.name\n                    const description = itemData.system.description || ''\n                    const actionTypeName = coreModule.api.Utils.i18n(ACTION_TYPE[actionTypeId])\n                    const listName = `${actionTypeName ? `${actionTypeName}: ` : ''}${name}<br>${description}`\n                    const encodedValue = [actionTypeId, id].join(this.delimiter)\n                    const img = coreModule.api.Utils.getImage(itemData)\n\n                    if (itemData.type === 'customWeapon' && itemData.system.isTransforming) {\n                        const activeForm = itemData.system[itemData.system.activeForm];\n                        if (activeForm.name)\n                            name = `${itemData.name} - ${activeForm.name}`\n\n                    }\n\n                    // Add tooltip if item has description\n                    const action = {\n                        id,\n                        name,\n                        listName,\n                        img,\n                        encodedValue\n                    }\n\n                    // Always show tooltip for items (even without description)\n                    action.tooltip = {\n                        content: this.#enrichItemTooltip(name, description, itemData),\n                        class: 'tah-system-tooltip',\n                        direction: this.tooltipDirection\n                    }\n\n                    return action\n                })\n\n                this.addActions(actions, groupData) // Add actions to the group\n            }\n\n            // Handle equipped items separately for the \"Equipped\" group\n            const equippedActions = [...this.items].filter(([itemId]) => equippedItemIds.has(itemId)).map(([itemId, itemData]) => {\n                const id = itemId\n                const name = itemData.name\n                const description = itemData.system.description || ''\n                const actionTypeName = coreModule.api.Utils.i18n(ACTION_TYPE[actionTypeId])\n                const listName = `${actionTypeName ? `${actionTypeName}: ` : ''}${name}<br>${description}`\n                const encodedValue = [actionTypeId, id].join(this.delimiter)\n                const img = coreModule.api.Utils.getImage(itemData)\n\n                const action = {\n                    id,\n                    name,\n                    listName,\n                    img,\n                    encodedValue\n                }\n\n                // Always show tooltip for items (even without description)\n                action.tooltip = {\n                    content: this.#enrichItemTooltip(name, description, itemData),\n                    class: 'tah-system-tooltip',\n                    direction: this.tooltipDirection\n                }\n\n                return action\n            })\n\n            // Add equipped actions to the \"Equipped\" group\n            const equippedGroupData = { id: 'equipped', type: 'system' }\n            this.addActions(equippedActions, equippedGroupData)\n        }\n    }\n})\n","import { GROUP } from './constants.js'\n\n/**\n * Default layout and groups\n */\nexport let DEFAULTS = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    const groups = GROUP\n    Object.values(groups).forEach((group) => {\n        group.name = coreModule.api.Utils.i18n(group.name)\n        group.listName = `${game.i18n.localize(\n            'tokenActionHud.fu.group'\n        )}: ${coreModule.api.Utils.i18n(group.listName ?? group.name)}`\n    })\n    const groupsArray = Object.values(groups)\n    console.info('Initializing token action hud layout for FU')\n    DEFAULTS = {\n        layout: [\n            {\n                nestId: 'attack',\n                id: 'attack',\n                name: coreModule.api.Utils.i18n('Attack'),\n                groups: [\n                    { ...groups.basic, nestId: 'attack_basic' },\n                    { ...groups.weapon, nestId: 'attack_weapon' },\n                    { ...groups.customWeapon, nestId: 'attack_customWeapon' }\n                ]\n            },\n            {\n                nestId: 'feature',\n                id: 'feature',\n                name: coreModule.api.Utils.i18n('Skill'),\n                groups: [\n                    { ...groups.skill, nestId: 'feature_skill' },\n                    { ...groups.miscAbility, nestId: 'feature_miscAbility' },\n                    // { ...groups.rule, nestId: 'feature_rule' },\n                    // { ...groups.ritual, nestId: 'feature_ritual' },\n                    // { ...groups.project, nestId: 'feature_project' },\n                    { ...groups.classFeature, nestId: 'feature_classFeature' },\n                    { ...groups.optionalFeature, nestId: 'feature_optionalFeature' }\n                ]\n            },\n            {\n                nestId: 'spell',\n                id: 'spell',\n                name: coreModule.api.Utils.i18n('Spell'),\n                groups: [\n                    { ...groups.spell, nestId: 'spell_spell' },\n                    // { ...groups.ritual, nestId: 'spell_ritual' }\n                ]\n            },\n            {\n                nestId: 'item',\n                id: 'item',\n                name: coreModule.api.Utils.i18n('Items'),\n                groups: [\n                    { ...groups.consumable, nestId: 'item_consumable' },\n                    { ...groups.equipped, nestId: 'item_equipped' },\n                    // { ...groups.shield, nestId: 'item_shield' },\n                    // { ...groups.armor, nestId: 'item_armor' },\n                    // { ...groups.accessory, nestId: 'item_accessory' },\n                    // { ...groups.treasure, nestId: 'item_treasure' }\n                ]\n            },\n            {\n                nestId: 'action',\n                id: 'action',\n                name: coreModule.api.Utils.i18n('Action'),\n                groups: [\n                    { ...groups.action, nestId: 'action_action' },\n                    // { ...groups.check, nestId: 'action_check' }\n                ]\n            },\n            {\n                nestId: 'effect',\n                id: 'effect',\n                name: coreModule.api.Utils.i18n('Effect'),\n                groups: [\n                    { ...groups.temporaryEffect, nestId: 'effect_temporary' },\n                    { ...groups.passiveEffect, nestId: 'effect_passive' },\n                    { ...groups.inactiveEffect, nestId: 'effect_inactive' }\n                ]\n            },\n            {\n                nestId: 'utility',\n                id: 'utility',\n                name: coreModule.api.Utils.i18n('tokenActionHud.utility'),\n                groups: [\n                    { ...groups.combat, nestId: 'utility_combat' },\n                    { ...groups.token, nestId: 'utility_token' },\n                    { ...groups.rests, nestId: 'utility_rests' },\n                    { ...groups.utility, nestId: 'utility_utility' },\n                    { ...groups.downtime, nestId: 'utility_downtime' }\n                ]\n            }\n        ],\n        groups: groupsArray\n    }\n})\n","export let RollHandler = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Extends Token Action HUD Core's RollHandler class and handles action events triggered when an action is clicked\n     */\n    RollHandler = class RollHandler extends coreModule.api.RollHandler {\n        /**\n         * Handle action click\n         * Called by Token Action HUD Core when an action is left or right-clicked\n         * @override\n         * @param {object} event        The event\n         * @param {string} encodedValue The encoded value\n         */\n        async handleActionClick (event, encodedValue) {\n            const [actionTypeId, actionId] = encodedValue.split('|')\n            const isShift = this.isShift;\n\n            const renderable = ['item']\n\n            if (renderable.includes(actionTypeId) && this.isRenderItem()) {\n                return this.renderItem(this.actor, actionId)\n            }\n\n            const knownCharacters = ['character']\n\n            // If single actor is selected\n            if (this.actor) {\n                await this.#handleAction(event, this.actor, this.token, actionTypeId, actionId, isShift)\n                return\n            }\n\n            const controlledTokens = canvas.tokens.controlled\n                .filter((token) => knownCharacters.includes(token.actor?.type))\n\n            // If multiple actors are selected\n            for (const token of controlledTokens) {\n                const actor = token.actor\n                await this.#handleAction(event, actor, token, actionTypeId, actionId, isShift)\n            }\n        }\n\n        /**\n         * Handle action hover\n         * Called by Token Action HUD Core when an action is hovered on or off\n         * @override\n         * @param {object} event        The event\n         * @param {string} encodedValue The encoded value\n         */\n        async handleActionHover (event, encodedValue) {}\n\n        /**\n         * Handle group click\n         * Called by Token Action HUD Core when a group is right-clicked while the HUD is locked\n         * @override\n         * @param {object} event The event\n         * @param {object} group The group\n         */\n        async handleGroupClick (event, group) {}\n\n        /**\n         * Handle action\n         * @private\n         * @param {object} event        The event\n         * @param {object} actor        The actor\n         * @param {object} token        The token\n         * @param {string} actionTypeId The action type id\n         * @param {string} actionId     The actionId\n         */\n        async #handleAction (event, actor, token, actionTypeId, actionId, isShift) {\n            switch (actionTypeId) {\n            case 'item':\n                this.#handleItemAction(event, actor, actionId)\n                break\n            case 'action':\n                this.#handleCombatAction(event, actor, actionId, isShift)\n                break\n            case 'effect':\n                this.#handleEffectAction(event, actor, actionId)\n                break\n            case 'utility':\n                this.#handleUtilityAction(event, actor, token, actionId)\n                break\n            }\n        }\n\n        /**\n         * Handles combat actions\n         *\n         * @private\n         * @param {Event} event     The event\n         * @param {Object} actor    The actor\n         * @param {string} actionId The action type id\n         * @param {boolean} isShift Whether Shift key was pressed\n         *\n         * @returns {Promise<void>}\n         */\n        async #handleCombatAction (event, actor, actionId, isShift) {\n            const combatActionHandler = new game.projectfu.ActionHandler(actor)\n\n            switch (actionId) {\n            case 'equipmentAction':\n                await combatActionHandler.handleAction('equipment', isShift)\n                break\n            case 'guardAction':\n                await combatActionHandler.handleAction('guard', isShift)\n                break\n            case 'hinderAction':\n                await combatActionHandler.handleAction('hinder', isShift)\n                break\n            case 'inventoryAction':\n                await combatActionHandler.handleAction('inventory', isShift)\n                break\n            case 'objectiveAction':\n                await combatActionHandler.handleAction('objective', isShift)\n                break\n            case 'spellAction':\n                await combatActionHandler.handleAction('spell', isShift)\n                break\n            case 'studyAction':\n                await combatActionHandler.handleAction('study', isShift)\n                break\n            case 'skillAction':\n                await combatActionHandler.handleAction('skill', isShift)\n                break\n            case 'attributeCheck':\n                Hooks.call('promptAttributeCheckCalled', actor)\n                break\n            case 'openCheck':\n                Hooks.call('promptOpenCheckCalled', actor)\n                break\n            case 'groupCheck':\n                Hooks.call('promptGroupCheckCalled', actor)\n                break\n            case 'initiativeCheck':\n                Hooks.call('promptInitiativeCheckCalled', actor)\n                break\n            default:\n                console.warn(`Unknown action ID: ${actionId}`)\n                break\n            }\n        }\n\n        /**\n         * @typedef KeyboardModifiers\n         * @property {boolean} shift\n         * @property {boolean} alt\n         * @property {boolean} ctrl\n         * @property {boolean} meta\n         */\n\n        /**\n         * Handle item action\n         * @private\n         * @param {Event} event    The event\n         * @param {object} actor    The actor\n         * @param {string} actionId The action id\n         */\n        #handleItemAction (event, actor, actionId) {\n            const item = actor.items.get(actionId)\n            /** @type KeyboardModifiers **/\n            const modifiers = {\n                shift: event.shiftKey,\n                ctrl: event.ctrlKey\n            }\n            if (item.type === 'customWeapon' && item.system.isTransforming && modifiers.ctrl) {\n                console.log('Changing form')\n                item.system.switchForm()\n            } else {\n                item.roll(modifiers)\n            }\n        }\n\n        /**\n         * @param {Event} event\n         * @param {Object} actor\n         * @param {String} effectId\n         */\n        async #handleEffectAction (event, actor, effectId) {\n            const isRightClick = event.type === 'contextmenu'\n            const effect = Array.from(actor.allEffects()).find((value) => value.id === effectId)\n            console.debug(`Handling click event for effect ${effectId} = ${effect.name}; RightClick: ${isRightClick}`)\n            const canBeManaged = !effect.statuses.has('crisis') && !effect.statuses.has('ko')\n            if (isRightClick && canBeManaged) {\n                // Don't allow deleting temporary effects from skills\n                const isTemporary = effect.isTemporary && effect.parent.type !== 'skill'\n                // Remove\n                if (isTemporary) {\n                    const confirmDelete = await foundry.applications.api.DialogV2.confirm({\n                        window: { title: game.i18n.localize('tokenActionHud.fu.dialog.confirmDeletionTitle') },\n                        content: `<p>${game.i18n.localize('tokenActionHud.fu.dialog.confirmDeletionContent')}</p>`\n                    })\n\n                    if (confirmDelete) {\n                        await effect.delete()\n                        this.#onUpdate()\n                    }\n                } else {\n                    // Toggle the effect\n                    await effect.update({ disabled: !effect.disabled })\n                    this.#onUpdate()\n                }\n            } else {\n                effect?.sheet?.render(true)\n            }\n        }\n\n        /**\n         * Handle utility action\n         * @private\n         * @param {Event} event\n         * @param {Object} actor\n         * @param {object} token    The token\n         * @param {string} actionId The action id\n         */\n        async #handleUtilityAction (event, actor, token, actionId) {\n            switch (actionId) {\n            case 'rest':\n                // Really\n                actor.rest()\n                break\n            }\n        }\n\n        /**\n         * @description Forces an update of the HUD\n         */\n        #onUpdate () {\n            Hooks.callAll('forceUpdateTokenActionHud')\n        }\n    }\n})\n","// import { MODULE } from './constants.js'\n\n/**\n * Register module settings\n * Called by Token Action HUD Core to register Token Action HUD system module settings\n * @param {function} coreUpdate Token Action HUD Core update function\n */\nexport function register (coreUpdate) {\n    // game.settings.register(MODULE.ID, 'displayUnequipped', {\n    //     name: game.i18n.localize('tokenActionHud.fu.settings.displayUnequipped.name'),\n    //     hint: game.i18n.localize('tokenActionHud.fu.settings.displayUnequipped.hint'\n    //     ),\n    //     scope: 'client',\n    //     config: true,\n    //     type: Boolean,\n    //     default: true,\n    //     onChange: (value) => {\n    //         coreUpdate(value)\n    //     }\n    // })\n}\n","// System Module Imports\nimport { ActionHandler } from './action-handler.js'\nimport { RollHandler as Core } from './roll-handler.js'\nimport { MODULE } from './constants.js'\nimport { DEFAULTS } from './defaults.js'\nimport * as systemSettings from './settings.js'\n\nexport let SystemManager = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Extends Token Action HUD Core's SystemManager class\n     */\n    SystemManager = class SystemManager extends coreModule.api.SystemManager {\n        /**\n         * Returns an instance of the ActionHandler to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @override\n         * @returns {class} The ActionHandler instance\n         */\n        getActionHandler () {\n            return new ActionHandler()\n        }\n\n        /**\n         * Returns a list of roll handlers to Token Action HUD Core\n         * Used to populate the Roll Handler module setting choices\n         * Called by Token Action HUD Core\n         * @override\n         * @returns {object} The available roll handlers\n         */\n        getAvailableRollHandlers () {\n            const coreTitle = 'Fabula Ultima'\n            const choices = { core: coreTitle }\n            return choices\n        }\n\n        /**\n         * Returns an instance of the RollHandler to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @override\n         * @param {string} rollHandlerId The roll handler ID\n         * @returns {class}              The RollHandler instance\n         */\n        getRollHandler (rollHandlerId) {\n            let rollHandler\n            switch (rollHandlerId) {\n            case 'core':\n            default:\n                rollHandler = new Core()\n                break\n            }\n            return rollHandler\n        }\n\n        /**\n         * Returns the default layout and groups to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @returns {object} The default layout and groups\n         */\n        async registerDefaults () {\n            return DEFAULTS\n        }\n\n        /**\n         * Register Token Action HUD system module settings\n         * Called by Token Action HUD Core\n         * @override\n         * @param {function} coreUpdate The Token Action HUD Core update function\n         */\n        registerSettings (coreUpdate) {\n            systemSettings.register(coreUpdate)\n        }\n\n        /**\n         * Returns styles to Token Action HUD Core\n         * Called by Token Action HUD Core\n         * @override\n         * @returns {object} The TAH system styles\n         */\n        registerStyles () {\n            return {\n                // fuDefault: {\n                //     class: 'tah-style-fu-style', // The class to add to first DIV element\n                //     file: 'tah-fu-style', // The file without the css extension\n                //     moduleId: MODULE.ID, // The module ID\n                //     name: 'PFU Style' // The name to display in the Token Action HUD Core 'Style' module setting\n                // },\n                fuPixel: {\n                    class: 'tah-style-pixel-style', // The class to add to first DIV element\n                    file: 'tah-fu-pixel', // The file without the css extension\n                    moduleId: MODULE.ID, // The module ID\n                    name: 'Pixel Style' // The name to display in the Token Action HUD Core 'Style' module setting\n                }\n            }\n        }\n    }\n})\n","import { MODULE } from './constants.js'\n\nexport let Utils = null\n\nHooks.once('tokenActionHudCoreApiReady', async (coreModule) => {\n    /**\n     * Utility functions\n     */\n    Utils = class Utils {\n        /**\n         * Get setting\n         * @param {string} key               The key\n         * @param {string=null} defaultValue The default value\n         * @returns {string}                 The setting value\n         */\n        static getSetting (key, defaultValue = null) {\n            let value = defaultValue ?? null\n            try {\n                value = game.settings.get(MODULE.ID, key)\n            } catch {\n                coreModule.api.Logger.debug(`Setting '${key}' not found`)\n            }\n            return value\n        }\n\n        /**\n         * Set setting\n         * @param {string} key   The key\n         * @param {string} value The value\n         */\n        static async setSetting (key, value) {\n            try {\n                value = await game.settings.set(MODULE.ID, key, value)\n                coreModule.api.Logger.debug(`Setting '${key}' set to '${value}'`)\n            } catch {\n                coreModule.api.Logger.debug(`Setting '${key}' not found`)\n            }\n        }\n    }\n})\n"],"names":["MODULE","ID","CORE_MODULE","REQUIRED_CORE_MODULE_VERSION","ACTION_TYPE","basic","weapon","shield","armor","accessory","consumable","treasure","class","skill","heroic","spell","miscAbility","rule","behavior","ritual","project","classFeature","optionalFeature","effect","action","attack","equipment","guard","inventory","hinder","objective","study","check","travel","utility","GROUP","equipped","id","name","type","combat","token","temporaryEffect","passiveEffect","inactiveEffect","downtime","ITEM_TYPE","groupId","customWeapon","ActionHandler","Hooks","once","async","coreModule","api","this","actorType","actor","tooltipDirection","getTooltipDirection","items","Utils","sortItemsByName","effects","buildCharacterActions","buildNPCActions","buildMultipleTokenActions","buildCheckActions","buildCombatActions","buildItems","buildEffects","buildDowntimeActions","actionTypeId","actions","map","i18n","listName","encodedValue","join","delimiter","checkGroupData","addActions","actionObj","ruleText","tooltip","content","direction","combatGroupData","game","settings","get","enrichItemTooltip","description","itemData","itemType","charAt","toUpperCase","slice","stats","getItemStats","hints","system","isTransforming","push","rollInfo","accuracy","value","undefined","primary","attributes","secondary","damage","hasDamage","damageType","activeForm","length","stat","typeId","getAction","img","getImage","addEffectGroup","groupData","effectCategories","temporaryEffects","temporary","passiveEffects","passive","inactiveEffects","inactive","restAction","size","inventoryMap","Map","slots","equippedItemIds","Set","slot","equippedItemId","add","itemId","typeMap","set","actionTypeName","equippedActions","filter","has","DEFAULTS","groups","Object","values","forEach","group","localize","groupsArray","console","info","layout","nestId","rests","RollHandler","register","coreUpdate","event","actionId","split","isShift","includes","isRenderItem","renderItem","knownCharacters","handleAction","controlledTokens","canvas","tokens","controlled","handleItemAction","handleCombatAction","handleEffectAction","handleUtilityAction","combatActionHandler","projectfu","call","warn","item","modifiers","shift","shiftKey","ctrl","ctrlKey","log","switchForm","roll","effectId","isRightClick","Array","from","allEffects","find","debug","canBeManaged","statuses","isTemporary","parent","foundry","applications","DialogV2","confirm","window","title","delete","onUpdate","update","disabled","sheet","render","rest","callAll","SystemManager","getActionHandler","getAvailableRollHandlers","core","getRollHandler","rollHandlerId","rollHandler","Core","registerSettings","registerStyles","fuPixel","file","moduleId","static","key","defaultValue","Logger"],"mappings":"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"}